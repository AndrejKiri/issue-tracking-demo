name: AI PR Title Poet

on:
  pull_request:
    types: [opened, reopened, synchronize, edited]

permissions:
  pull-requests: write

jobs:
  poet:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install OpenAI client
        run: |
          python -m pip install --upgrade pip
          pip install openai

      - name: Generate poem from PR title
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          python - <<'PY'
          import os, textwrap
          from openai import OpenAI

          pr_title = os.environ["PR_TITLE"]
          client = OpenAI()

          system = "You are a playful poet. Write a short, witty poem inspired by a PR title."
          user = f'PR title: "{pr_title}"\n\nWrite a tiny poem (2‚Äì4 short lines), light and friendly. Avoid code blocks and hashtags. Keep it under 60 words.'

          resp = client.chat.completions.create(
              model="gpt-4o-mini",
              messages=[
                  {"role": "system", "content": system},
                  {"role": "user", "content": user},
              ],
          )
          poem = resp.choices[0].message.content.strip()

          body = textwrap.dedent(f"""\
          ### ‚úçÔ∏è AI PR Title Poem

          {poem}

          <sub>(based on the PR title)</sub>
          """)

          with open("ai_poem_comment.md", "w", encoding="utf-8") as f:
              f.write(body)
          PY

      - name: Diagnostic: verify gh access and context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "üîç Checking environment..."
          echo "Repo: $GITHUB_REPOSITORY"
          echo "PR Number: $PR_NUMBER"
          echo
          echo "üîç Checking gh CLI..."
          gh --version || { echo "gh CLI not available"; exit 1; }
          echo
          echo "üîç Verifying GH authentication..."
          gh auth status || { echo "Authentication failed"; exit 1; }
          echo
          echo "üîç Fetching PR details via API..."
          gh pr view "$PR_NUMBER" \
            --repo "$GITHUB_REPOSITORY" \
            --json number,title,author,headRefName,baseRefName,state \
            --jq '.'

      - name: Post PR comment (no checkout required)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          test -s ai_poem_comment.md || { echo "ai_poem_comment.md missing"; exit 1; }
          gh pr comment "$PR_NUMBER" \
            --repo "$GITHUB_REPOSITORY" \
            --body-file ai_poem_comment.md
